---
phase: 04-mcp-integration
plan: 02
subsystem: mcp
tags: [mcp, rmcp, tool-router, tool-handler, graph-query, mcp-server]
dependency-graph:
  requires: [rmcp-deps, tokio-runtime, mcp-cli-subcommand, format-to-string-api]
  provides: [mcp-stdio-server, 6-mcp-tools, lazy-graph-cache]
  affects: [src/mcp/server.rs, src/mcp/params.rs, src/mcp/mod.rs, src/main.rs]
tech-stack:
  added: []
  patterns: [tool-router-macro, tool-handler-macro, spawn-blocking-for-cpu-work, arc-mutex-graph-cache]
key-files:
  created: [src/mcp/params.rs, src/mcp/server.rs]
  modified: [src/mcp/mod.rs, src/main.rs]
decisions:
  - "Return Result<String, String> from tool handlers — Err maps to isError:true via IntoCallToolResult blanket impl"
  - "#[tool_handler] annotation required on ServerHandler impl to wire call_tool/list_tools/get_tool"
  - "Graph built in spawn_blocking to avoid blocking async executor during CPU-bound work"
  - "Fuzzy suggestions use substring + prefix matching (first 3 chars) returning up to 3 candidates"
  - "Truncation-aware headers replace formatter summary line when results.len() > limit"
metrics:
  duration: 23 min
  completed: 2026-02-23
---

# Phase 4 Plan 02: MCP Server Implementation Summary

Full MCP stdio server with 6 graph query tools using rmcp 0.16 proc macros, lazy graph caching via Arc<Mutex<HashMap>>, compact text responses, and isError fuzzy-suggestion error handling.

## Tasks Completed

| # | Task | Commit | Files |
|---|------|--------|-------|
| 1 | Create MCP param structs and server with 6 tool handlers | b3ffe6a | src/mcp/params.rs, src/mcp/server.rs, src/mcp/mod.rs |
| 2 | Wire MCP server into main and verify end-to-end | 412e53c | src/main.rs |

## What Was Built

### src/mcp/params.rs

Six typed parameter structs with `Deserialize + JsonSchema` for all MCP tools:

| Struct | Required Fields | Optional Fields |
|--------|----------------|-----------------|
| `FindSymbolParams` | `symbol` | `path`, `kind`, `limit`, `project_path` |
| `FindReferencesParams` | `symbol` | `limit`, `project_path` |
| `GetImpactParams` | `symbol` | `limit`, `project_path` |
| `DetectCircularParams` | — | `project_path` |
| `GetContextParams` | `symbol` | `project_path` |
| `GetStatsParams` | — | `project_path` |

### src/mcp/server.rs

`CodeGraphServer` struct with:
- `Arc<PathBuf>` default project root
- `Arc<Mutex<HashMap<PathBuf, Arc<CodeGraph>>>>` lazy graph cache
- `ToolRouter<Self>` field generated by `#[tool_router]` macro

**6 tool handlers** via `#[tool_router]` impl block, each using `Parameters<T>` extractor. All return `Result<String, String>`:
- `find_symbol` — uses `find_symbol()`, supports kind filter, path scope, and limit truncation
- `find_references` — uses `match_symbols()` + `find_refs()`, supports limit truncation
- `get_impact` — uses `match_symbols()` + `blast_radius()`, supports limit truncation
- `detect_circular` — uses `find_circular()`, no symbol param
- `get_context` — uses `match_symbols()` + `symbol_context()` per match
- `get_stats` — uses `project_stats()`

`#[tool_handler]` on `ServerHandler` impl wires `call_tool`, `list_tools`, and `get_tool` methods automatically.

**Graph resolution flow** per tool call:
1. Determine effective path (override > default)
2. Check mutex-protected cache
3. If miss: build graph via `spawn_blocking(|| crate::build_graph(path, false))`
4. Check for empty graph (0 files) → return error message
5. Store in cache and return

### src/mcp/mod.rs

```rust
pub async fn run(project_root: PathBuf) -> anyhow::Result<()> {
    let service = server::CodeGraphServer::new(project_root);
    let server = rmcp::serve_server(service, stdio()).await?;
    server.waiting().await?;
    Ok(())
}
```

### src/main.rs changes

- `fn build_graph` → `pub(crate) fn build_graph` so mcp::server can call `crate::build_graph()`
- `Commands::Mcp` arm now calls `mcp::run(project_root).await?` with fallback to `current_dir()`

## Tool Descriptions (verified under 100 tokens each)

| Tool | Characters | ~Tokens |
|------|-----------|---------|
| `find_symbol` | 86 | ~21 |
| `find_references` | 83 | ~20 |
| `get_impact` | 78 | ~19 |
| `detect_circular` | 75 | ~18 |
| `get_context` | 86 | ~21 |
| `get_stats` | 82 | ~20 |

## Decisions Made

1. **`Result<String, String>` return type**: Returning `String` from tool handlers maps to `CallToolResult::success()`. Returning `Err(String)` maps to `CallToolResult::error()` (isError:true) via the blanket impl `IntoCallToolResult for Result<T: IntoContents, E: IntoContents>`. This is cleaner than constructing `CallToolResult` directly.

2. **`#[tool_handler]` annotation required**: `#[tool_router]` only generates `tool_router()` constructor and `*_tool_attr()` helper functions. Without `#[tool_handler]` on the `ServerHandler` impl, `list_tools` returns empty and `call_tool` returns "method not found". The annotation generates the routing implementations.

3. **`spawn_blocking` for graph build**: `build_graph` is CPU-bound (file I/O + parsing). Running it directly in an async context would block the tokio executor. Using `spawn_blocking` offloads it to the blocking thread pool.

4. **Fuzzy suggestions**: Simple prefix (first 3 chars) and substring matching against `graph.symbol_index` keys. Returns up to 3 alphabetically sorted matches. Does not require Levenshtein distance calculation — fast enough for interactive use.

5. **Truncation header replacement**: When results exceed limit, the formatter's summary line (first line) is replaced with a truncation-aware version: `"showing {limit}/{total} definitions (increase limit for more)"`. This preserves the CONTEXT.md decision that the first line is always a count summary.

## Verification

- `cargo build` — clean build, zero errors, 7 pre-existing dead-code warnings (unchanged)
- `cargo test` — 87 tests pass, 0 failed, 0 regressions
- MCP initialize handshake returns `{"capabilities":{"tools":{}}}` with server instructions
- `tools/list` returns exactly 6 tools with correct names and schemas
- `find_symbol` on real TypeScript code returns compact text: `def greetUser index.ts:1 function`
- Not-found symbol returns `isError: true` with message
- `get_stats` returns compact text with symbol breakdown

## Deviations from Plan

**1. [Rule 1 - Bug] Added #[tool_handler] annotation**
- **Found during:** Task 1 verification
- **Issue:** `#[tool_router]` alone does not wire `call_tool` and `list_tools` into `ServerHandler`. Without `#[tool_handler]`, `tools/list` returned empty and tool calls failed.
- **Fix:** Added `#[tool_handler]` attribute on the `ServerHandler` impl and imported `tool_handler` from rmcp.
- **Files modified:** `src/mcp/server.rs`
- **Commit:** b3ffe6a (included in same commit)

**2. [Rule 3 - Blocking] rustup toolchain switch to stable 1.93.1**
- **Found during:** First build attempt
- **Issue:** Cargo 1.84.1 was active but the project requires edition 2024 which needs Cargo 1.85+. The STATE.md noted this was resolved in Phase 01 but the environment reset to 1.84.1.
- **Fix:** `rustup default stable` to switch to stable 1.93.1 (already installed).
- **Files modified:** None (environment change only)

**3. [Rule 1 - Bug] Return type changed from CallToolResult to Result<String, String>**
- **Found during:** First compile attempt
- **Issue:** `#[tool_router]` macro expects handlers returning `IntoCallToolResult`. `CallToolResult` itself does NOT implement `IntoCallToolResult` (only `Result<CallToolResult, ErrorData>` does). Returning `CallToolResult` directly caused trait bound errors.
- **Fix:** Changed all 6 handlers to return `Result<String, String>`. `String` implements `IntoContents`, so `Result<String, String>` satisfies the blanket impl `IntoCallToolResult for Result<T: IntoContents, E: IntoContents>`. Error variants produce `isError: true` responses.
- **Files modified:** `src/mcp/server.rs`
- **Commit:** b3ffe6a (included in same commit)

## Self-Check: PASSED

- [x] `src/mcp/params.rs` exists with 6 param structs
- [x] `src/mcp/server.rs` exists with CodeGraphServer and 6 tool handlers
- [x] `src/mcp/mod.rs` has run() entrypoint calling serve_server + stdio
- [x] `src/main.rs` has mcp::run() in Commands::Mcp arm and pub(crate) build_graph
- [x] Commits b3ffe6a and 412e53c exist in git log
- [x] `cargo build` succeeds
- [x] `cargo test` passes (87/87)
- [x] MCP initialize handshake returns tools capability
- [x] tools/list returns exactly 6 tools
- [x] find_symbol returns compact text (not JSON)
- [x] Not-found symbol returns isError:true
