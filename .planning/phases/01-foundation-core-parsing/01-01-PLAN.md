---
phase: 01-foundation-core-parsing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/cli.rs
  - src/config.rs
  - src/walker.rs
autonomous: true
requirements:
  - PARS-01

must_haves:
  truths:
    - "Running `cargo build` produces a working `code-graph` binary"
    - "`code-graph index .` discovers all .ts/.tsx/.js/.jsx files in a test project"
    - "Files in .gitignore are excluded from discovery"
    - "node_modules is always excluded even if not in .gitignore"
    - "Monorepo workspaces from package.json are detected and included in the walk"
    - "`code-graph index . -v` prints each discovered file path"
    - "`code-graph index . --json` outputs JSON instead of human-readable text"
    - "code-graph.toml additional exclusions are respected"
  artifacts:
    - path: "Cargo.toml"
      provides: "Project manifest with all Phase 1 dependencies"
      contains: "tree-sitter"
    - path: "src/main.rs"
      provides: "Entry point dispatching CLI commands"
      min_lines: 10
    - path: "src/cli.rs"
      provides: "Clap derive CLI structs with index subcommand"
      exports: ["Cli", "Commands"]
    - path: "src/config.rs"
      provides: "code-graph.toml parsing with serde"
      exports: ["CodeGraphConfig"]
    - path: "src/walker.rs"
      provides: "File discovery with gitignore, node_modules exclusion, monorepo detection"
      exports: ["walk_project"]
  key_links:
    - from: "src/main.rs"
      to: "src/cli.rs"
      via: "Cli::parse() dispatch"
      pattern: "Cli::parse"
    - from: "src/walker.rs"
      to: "src/config.rs"
      via: "Config exclusions passed to walker"
      pattern: "CodeGraphConfig"
---

<objective>
Scaffold the Rust project with all Phase 1 dependencies, implement the CLI interface, configuration parsing, and file discovery system.

Purpose: Establishes the runnable binary and file discovery pipeline that all subsequent plans build upon. Without this, nothing can parse or index.
Output: A `code-graph` binary that can discover TS/JS files in a project respecting .gitignore, node_modules exclusion, and monorepo workspaces.
</objective>

<execution_context>
@/Users/monsieurbarti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/monsieurbarti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-parsing/01-CONTEXT.md
@.planning/phases/01-foundation-core-parsing/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Cargo project with CLI and config</name>
  <files>
    Cargo.toml
    src/main.rs
    src/cli.rs
    src/config.rs
  </files>
  <action>
    Create the Cargo project with `cargo init --name code-graph` (or create Cargo.toml manually if already in the directory).

    **Cargo.toml dependencies** (exact versions from research):
    ```toml
    tree-sitter = "0.26"
    tree-sitter-typescript = "0.23"
    tree-sitter-javascript = "0.25"
    ignore = "0.4"
    petgraph = { version = "0.6", features = ["stable_graph"] }
    clap = { version = "4", features = ["derive"] }
    serde = { version = "1", features = ["derive"] }
    serde_json = "1"
    toml = "0.8"
    anyhow = "1"
    glob = "0.3"
    ```

    Note: Use toml 0.8 per research recommendation (wider ecosystem compat).

    **src/cli.rs** — Clap derive structs:
    - `Cli` struct with `#[derive(Parser)]`, name "code-graph", version, about
    - `Commands` enum with `Index` variant taking:
      - `path: PathBuf` (positional, project root)
      - `--verbose` / `-v` flag (bool)
      - `--json` flag (bool)
    - Style: cargo-like help text

    **src/config.rs** — Configuration:
    - `CodeGraphConfig` struct with serde Deserialize:
      - `exclude: Option<Vec<String>>` (additional path patterns to exclude)
    - `impl CodeGraphConfig`:
      - `load(root: &Path) -> Self` — reads `code-graph.toml` from root, returns defaults if not found
      - Default: empty exclude list
    - Use `toml::from_str` for parsing

    **src/main.rs** — Entry point:
    - Parse CLI with `Cli::parse()`
    - Match on `Commands::Index { path, verbose, json }`
    - Load config with `CodeGraphConfig::load(&path)`
    - For now, just print "Indexing {path}..." — the full pipeline comes in Plan 03
    - Use `anyhow::Result` as return type

    Verify the project compiles: `cargo build`
  </action>
  <verify>
    `cargo build` succeeds. `./target/debug/code-graph index . --help` shows the index subcommand with path, --verbose, --json options.
  </verify>
  <done>
    Binary compiles, CLI parses arguments correctly, config loads from code-graph.toml (or defaults when absent).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement file walker with gitignore, node_modules exclusion, and monorepo detection</name>
  <files>
    src/walker.rs
    src/main.rs
  </files>
  <action>
    **src/walker.rs** — File discovery:

    Create a `walk_project(root: &Path, config: &CodeGraphConfig, verbose: bool) -> anyhow::Result<Vec<PathBuf>>` function:

    1. **Monorepo detection** — Before walking, check for `package.json` at root:
       - Define `PackageJson` struct with `workspaces: Option<WorkspacesField>`
       - `WorkspacesField` enum (untagged serde): `Patterns(Vec<String>)` or `Config { packages: Vec<String> }`
       - If workspaces found, resolve glob patterns to directories using the `glob` crate
       - If no workspaces, just use root as the single walk root

    2. **File walking** — For each root (main root + workspace dirs):
       - Use `ignore::WalkBuilder::new(root)` with `.standard_filters(true)`
       - Add `.filter_entry()` closure that:
         - Hard-excludes `node_modules` by directory name (non-negotiable per user decision)
         - Hard-excludes any directory matching `config.exclude` patterns
       - Filter yielded entries by extension: only `.ts`, `.tsx`, `.js`, `.jsx`
       - If `verbose`, print each discovered file path to stderr (not stdout — stdout is for output)

    3. **Return** collected `Vec<PathBuf>` of all discovered files

    **src/main.rs** — Wire the walker:
    - In the `Index` command handler, call `walk_project(&path, &config, verbose)?`
    - Print the file count (temporary summary until Plan 03 builds the full pipeline)
    - If `--json`, print `{"files": N}` as placeholder

    **Important patterns from research:**
    - Use `ignore::WalkBuilder` NOT `walkdir` — do not hand-roll gitignore
    - The `filter_entry` closure runs on directory entries too, so checking filename against "node_modules" catches the directory before descent
    - `standard_filters(true)` automatically reads .gitignore, .git/info/exclude, and global gitignore
  </action>
  <verify>
    Create a temporary test directory structure:
    ```bash
    mkdir -p /tmp/cg-test/{src,node_modules/pkg,dist}
    echo "export const a = 1;" > /tmp/cg-test/src/app.ts
    echo "export const b = 2;" > /tmp/cg-test/src/index.tsx
    echo "const c = 3;" > /tmp/cg-test/src/util.js
    echo "export default 4;" > /tmp/cg-test/src/comp.jsx
    echo "should be excluded" > /tmp/cg-test/node_modules/pkg/index.js
    echo "should be excluded" > /tmp/cg-test/dist/bundle.js
    echo "dist/" > /tmp/cg-test/.gitignore
    cargo run -- index /tmp/cg-test -v
    ```
    Expected: 4 files discovered (app.ts, index.tsx, util.js, comp.jsx). node_modules/pkg/index.js excluded. dist/bundle.js excluded via .gitignore.
  </verify>
  <done>
    File walker discovers all .ts/.tsx/.js/.jsx files, excludes node_modules always, respects .gitignore, and applies config exclusions. Verbose mode prints file paths to stderr.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `code-graph index /tmp/cg-test` reports 4 files (not 6)
3. `code-graph index /tmp/cg-test -v` prints each of the 4 file paths
4. `code-graph index /tmp/cg-test --json` outputs JSON format
5. node_modules directory is excluded even without .gitignore
6. .gitignore exclusions (dist/) are respected
</verification>

<success_criteria>
- Binary builds and runs
- File discovery is correct: includes .ts/.tsx/.js/.jsx, excludes node_modules and .gitignore paths
- CLI flags work: --verbose shows file paths, --json outputs JSON
- Config file loads when present, defaults when absent
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-parsing/01-01-SUMMARY.md`
</output>
